<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Digital Scientific Library (DSL)</title>
  <style>
    body {
      background-color: #0b0c10;
      color: #eaeaea;
      font-family: sans-serif;
      padding: 2em;
    }
    h1 { color: #66fcf1; }
    .bookshelf {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      margin-top: 1em;
    }
    .book {
      background: #1f2833;
      padding: 1em;
      border-radius: 5px;
      cursor: pointer;
      width: 120px;
      text-align: center;
      transition: transform 0.2s;
    }
    .book:hover {
      transform: scale(1.05);
      background-color: #2b3b4f;
    }
    #reader {
      margin-top: 2em;
      background: #1f2833;
      padding: 1em;
      border-radius: 5px;
      display: none;
    }
    textarea {
      width: 100%;
      max-width: 600px;
      height: 100px;
      background: #1f2833;
      color: #66fcf1;
      border: 1px solid #45a29e;
      padding: 0.5em;
      font-family: monospace;
    }
    button {
      background-color: #45a29e;
      color: #0b0c10;
      border: none;
      padding: 0.5em 1em;
      margin-top: 0.5em;
      cursor: pointer;
    }
    a {
      color: #45a29e;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>Digital Scientific Library</h1>

  <section>
    <h2>Browse Repository</h2>
    <div id="fileViewer">Loading...</div>
    <div id="reader">
      <h3>Reader</h3>
      <pre id="fileContent">Click a book to read...</pre>
    </div>
  </section>

  <section style="margin-top: 2em;">
    <h2>Add Scraping Keywords</h2>
    <p>Enter scientific keywords to auto-scrape new content via GitHub Action:</p>
    <textarea id="keywords" placeholder="e.g. fusion, dark matter, CRISPR..."></textarea><br>
    <button onclick="saveKeywords()">Save Keywords</button>
  </section>

  <script>
    const username = "purpleparrotpartpradime";
    const repo = "DSL-Digital-Scientific-Library-.GitHub.engine.io.dsl.mdot";
    const API_BASE = `https://api.github.com/repos/${username}/${repo}/contents/`;
    const headers = {
      "Authorization": "token REPLACE_WITH_YOUR_PAT_IF_RUNNING_LOCALLY",
      "Accept": "application/vnd.github.v3+json"
    };

    async function loadFiles(path = "") {
      const viewer = document.getElementById("fileViewer");
      viewer.innerHTML = "";

      try {
        const res = await fetch(API_BASE + path, { headers });
        const items = await res.json();

        const shelf = document.createElement("div");
        shelf.className = "bookshelf";

        if (Array.isArray(items)) {
          for (const item of items) {
            const el = document.createElement("div");
            el.className = "book";

            if (item.type === "dir") {
              el.innerText = item.name;
              el.onclick = () => loadFiles(item.path);
            } else {
              el.innerText = item.name;
              el.onclick = () => openFile(item.download_url);
            }

            shelf.appendChild(el);
          }

          if (path !== "") {
            const back = document.createElement("div");
            back.className = "book";
            back.style.background = "#333";
            back.innerText = "← Back";
            back.onclick = () => loadFiles(path.split("/").slice(0, -1).join("/"));
            shelf.prepend(back);
          }

          viewer.appendChild(shelf);
        } else {
          viewer.innerText = "No files found.";
        }
      } catch (err) {
        viewer.innerText = "Error loading files.";
        console.error(err);
      }
    }

    async function openFile(url) {
      try {
        const res = await fetch(url);
        const text = await res.text();
        document.getElementById("reader").style.display = "block";
        document.getElementById("fileContent").textContent = text;
      } catch (err) {
        alert("Failed to load file.");
      }
    }

    async function saveKeywords() {
      const keywords = document.getElementById("keywords").value.trim();
      if (!keywords) return;
      const content = btoa(keywords);
      const path = "config/keywords.txt";

      try {
        const existing = await fetch(API_BASE + path, { headers }).then(r => r.ok ? r.json() : null);
        const sha = existing?.sha;

        const method = "PUT";
        const body = {
          message: sha ? "Update keywords" : "Create keywords",
          content,
          ...(sha && { sha })
        };

        const res = await fetch(API_BASE + path, {
          method,
          headers,
          body: JSON.stringify(body)
        });

        if (res.ok) {
          alert("Keywords saved!");
        } else {
          console.error("Failed to save:", await res.text());
        }
      } catch (err) {
        console.error("Error saving keywords:", err);
      }
    }

    loadFiles();
  </script>
</body>
</html>
